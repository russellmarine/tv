<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="/favicon.png">
  <meta charset="UTF-8" />
  <title>Russell TV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      padding: 0;
      background: url("/background.png") no-repeat center center fixed;
      background-size: cover;
      background-color: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #fff;
    }

    header {
      background: rgba(0,0,0,0.8);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }

    .mode-toggle {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      border: 1px solid #ffffff44;
      background: rgba(0,0,0,0.7);
      color: #fff;
      font-size: 0.85rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn.active {
      background: #2e7dd7;
      border-color: #2e7dd7;
    }

    main {
      padding: 0.75rem;
      padding-bottom: 2.2rem; /* leave room for footer */
      box-sizing: border-box;
    }

    #single-view,
    #grid-view {
      box-sizing: border-box;
    }

    /* -------- SINGLE VIEW -------- */
    .single-layout {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
    }

    .single-video-card {
      flex: 0 1 70%;
      max-width: 960px;
      background: rgba(0,0,0,0.6);
      border-radius: 12px;
      padding: 0.5rem;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .single-side-panel {
      flex: 1;
      min-height: 200px;
      border-radius: 12px;
      border: 1px dashed rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      box-sizing: border-box;
    }

    #single-player-hls,
    #single-player-yt {
      width: 100%;
      max-width: 100%;
      aspect-ratio: 16 / 9;
      height: auto;
      display: none;
      border-radius: 12px;
      background: #000;
      border: none;
    }

    /* -------- GRID VIEW -------- */
    #grid-view {
      display: none;
    }

    .grid-wrapper {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-auto-rows: 1fr;
      gap: 0.75rem;
      height: 60vh; /* keeps 2x2 grid within screen */
    }

    .grid-cell {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
      background: transparent;
      border-radius: 12px;
      overflow: hidden;
    }

    .grid-header {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.5rem;
      padding: 0.15rem 0.5rem 0 0.5rem;
      box-sizing: border-box;
    }

    .grid-label {
      display: none; /* hide duplicate label; only use dropdown */
    }

    .grid-select {
      font-size: 0.75rem;
      background: rgba(0,0,0,0.8);
      color: #fff;
      border-radius: 999px;
      border: 1px solid #ffffff44;
      padding: 0.25rem 0.55rem;
      cursor: pointer;
    }

    .grid-body {
      flex: 1 1 auto;
      padding: 0.25rem 0.5rem 0.5rem;
      box-sizing: border-box;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .grid-frame {
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.15);
      border-radius: 12px;
      padding: 0.25rem;
      box-sizing: border-box;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .grid-frame > video,
    .grid-frame > .yt-container,
    .grid-frame > iframe {
      width: 100%;
      max-width: 100%;
      aspect-ratio: 16 / 9;
      height: auto;
      object-fit: contain;
      background: #000;
      border-radius: 8px;
    }

    .yt-container {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .yt-container iframe {
      width: 100%;
      height: 100%;
      border-radius: 8px;
      border: none;
      background: #000;
    }

    /* -------- INFO BAR (DESKTOP) -------- */
    #info-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      color: #fff;
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
      box-sizing: border-box;
      z-index: 1000;
      overflow: hidden;
    }

    /* Mobile marquee bar container (cloned from desktop) */
    #info-bar-mobile {
      display: none;
    }

    /* -------- MOBILE LAYOUT -------- */
    .channel-select-mobile-wrapper {
      display: none;
    }

    @media (max-width: 768px) {
      body {
        background-attachment: scroll;
      }

      header {
        padding: 0.5rem 0.75rem;
        flex-direction: column;
        align-items: flex-start;
      }

      header h1 {
        font-size: 1rem;
      }

      .btn {
        font-size: 0.8rem;
        padding: 0.3rem 0.7rem;
      }

      main {
        padding: 0.5rem;
        padding-bottom: 2rem;
      }

      .single-layout {
        flex-direction: column;
      }

      .single-video-card {
        flex: 1 1 auto;
        max-width: 100%;
      }

      .single-side-panel {
        width: 100%;
        min-height: 120px;
      }

      .grid-wrapper {
        grid-template-columns: 1fr;
        height: auto;
      }

      #single-player-hls,
      #single-player-yt {
        max-height: 60vh;
      }

      /* Hide per-channel buttons; use dropdown instead */
      #dynamic-buttons {
        display: none !important;
      }

      .channel-select-mobile-wrapper {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .channel-select-mobile {
        background: rgba(0,0,0,0.8);
        color: #fff;
        border-radius: 999px;
        border: 1px solid #ffffff44;
        padding: 0.3rem 0.7rem;
        font-size: 0.8rem;
      }

      /* Mobile: hide desktop footer, show ticker footer */
      #info-bar {
        display: none !important;
      }

      #info-bar-mobile {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.9);
        color: #fff;
        font-size: 0.6rem;
        height: 2.4rem;
        padding: 0.25rem 0.35rem;
        box-sizing: border-box;
        z-index: 1000;
        overflow: hidden;
        display: block;
      }

      #info-bar-mobile-inner {
        display: inline-flex;
        flex-wrap: nowrap;
        align-items: flex-start;
        gap: 1.2rem;
        white-space: nowrap;
      }

      #info-bar-mobile-inner.ticker-running {
        animation: infoBarTicker 70s linear infinite;
      }

      #info-bar-mobile-inner > * {
        display: inline-flex;
        flex-direction: column;
        padding: 0 0.35rem;
        margin: 0;
      }

      #info-bar-mobile-inner br {
        display: inline;
      }

      #info-bar-mobile:hover #info-bar-mobile-inner {
        animation-play-state: paused;
      }
    }

    @keyframes infoBarTicker {
      0%   { transform: translateX(0%); }
      100% { transform: translateX(-100%); }
    }
  </style>
</head>

<body>
  <header>
    <h1>Russell TV</h1>

    <!-- Mobile channel dropdown (shown only on mobile via CSS) -->
    <div class="channel-select-mobile-wrapper">
      <select id="channel-select-mobile" class="channel-select-mobile">
        <option value="">Select channel</option>
      </select>
    </div>

    <!-- Desktop channel buttons -->
    <div id="dynamic-buttons" class="mode-toggle"></div>

    <!-- Mode toggle -->
    <div class="mode-toggle">
      <button id="btn-single" class="btn active">Single</button>
      <button id="btn-grid" class="btn">Grid (4)</button>
    </div>
  </header>

  <main>
    <!-- SINGLE VIEW -->
    <section id="single-view">
      <div class="single-layout">
        <div class="single-video-card">
          <video id="single-player-hls" controls autoplay muted playsinline></video>
          <div id="single-player-yt" style="display:none;"></div>
        </div>
        <div class="single-side-panel" id="single-side-panel"></div>
      </div>
    </section>

    <!-- GRID VIEW -->
    <section id="grid-view">
      <div class="grid-wrapper">
        <!-- CELLS GENERATED DYNAMICALLY -->
      </div>
    </section>
  </main>

  <!-- Desktop info bar is still created by info-bar.js -->
  <!-- Mobile ticker uses a cloned version -->
  <div id="info-bar-mobile"><div id="info-bar-mobile-inner"></div></div>

  <!-- CONFIG -->
  <script src="/config/channels.js"></script>

  <!-- HLS.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <!-- YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    // DOM refs
    const singleView = document.getElementById("single-view");
    const gridView = document.getElementById("grid-view");
    const singleHLS = document.getElementById("single-player-hls");
    const singleYTContainer = document.getElementById("single-player-yt");

    const btnSingle = document.getElementById("btn-single");
    const btnGrid = document.getElementById("btn-grid");

    let hlsSingle = null;
    const hlsGrid = {};
    const YT_PLAYERS = {};

    function onYouTubeIframeAPIReady() {
      // API is ready; players are created lazily when needed.
    }

    function getYouTubeVideoId(url) {
      if (!url) return null;
      const idx = url.indexOf("/embed/");
      if (idx === -1) return null;
      let idPart = url.substring(idx + 7);
      const qIdx = idPart.indexOf("?");
      if (qIdx !== -1) idPart = idPart.substring(0, qIdx);
      return idPart;
    }

    function destroyYTPlayer(playerKey) {
      if (YT_PLAYERS[playerKey]) {
        try {
          YT_PLAYERS[playerKey].destroy();
        } catch (e) {
          console.warn("Error destroying YT player", playerKey, e);
        }
        delete YT_PLAYERS[playerKey];
      }
    }

    function createOrReplaceYTPlayer(container, playerKey, videoUrl) {
      const videoId = getYouTubeVideoId(videoUrl);
      if (!videoId) {
        console.warn("Could not parse YouTube video ID from URL:", videoUrl);
        return;
      }

      destroyYTPlayer(playerKey);

      container.innerHTML = "";
      const innerId = playerKey + "-inner";
      const inner = document.createElement("div");
      inner.id = innerId;
      inner.style.width = "100%";
      inner.style.height = "100%";
      container.appendChild(inner);

      function build() {
        if (window.YT && typeof YT.Player === "function") {
          const player = new YT.Player(innerId, {
            videoId: videoId,
            playerVars: {
              autoplay: 1,
              mute: 1,
              controls: 1,
              rel: 0,
              playsinline: 1
            },
            events: {
              onReady: (e) => {
                e.target.setPlaybackQuality("large");
              },
              onStateChange: (e) => {
                if (e.data === YT.PlayerState.PLAYING) {
                  e.target.setPlaybackQuality("large");
                }
              }
            }
          });
          YT_PLAYERS[playerKey] = player;
        } else {
          setTimeout(build, 100);
        }
      }

      build();
    }

    // -------- HEADER CHANNEL BUTTONS (DESKTOP) --------
    const headerBtnContainer = document.getElementById("dynamic-buttons");

    CHANNEL_ORDER.forEach(key => {
      const btn = document.createElement("button");
      btn.id = `btn-${key}`;
      btn.className = "btn";
      btn.textContent = CHANNELS[key].label;

      btn.addEventListener("click", () => {
        enterSingleMode();
        setSingleChannel(key);
      });

      headerBtnContainer.appendChild(btn);
    });

    function highlightHeaderButton(key) {
      const all = headerBtnContainer.querySelectorAll(".btn");
      all.forEach(b => b.classList.remove("active"));

      const active = document.getElementById(`btn-${key}`);
      if (active) active.classList.add("active");
    }

    // -------- SINGLE VIEW --------
    function stopSingle() {
      if (hlsSingle) {
        hlsSingle.destroy();
        hlsSingle = null;
      }
      singleHLS.pause();
      singleHLS.removeAttribute("src");
      singleHLS.load();

      destroyYTPlayer("single");
      singleYTContainer.innerHTML = "";
      singleYTContainer.style.display = "none";
      singleHLS.style.display = "block";
    }

    function setSingleChannel(key) {
      const ch = CHANNELS[key];
      highlightHeaderButton(key);

      // Sync mobile dropdown
      const mobileSelect = document.getElementById("channel-select-mobile");
      if (mobileSelect) {
        mobileSelect.value = key;
      }

      stopGrid();
      stopSingle();

      if (ch.type === "yt") {
        singleHLS.style.display = "none";
        singleYTContainer.style.display = "block";
        createOrReplaceYTPlayer(singleYTContainer, "single", ch.url);
      } else {
        singleYTContainer.style.display = "none";
        singleHLS.style.display = "block";

        if (Hls.isSupported()) {
          hlsSingle = new Hls({ lowLatencyMode: true });
          hlsSingle.loadSource(ch.url);
          hlsSingle.attachMedia(singleHLS);
        } else {
          singleHLS.src = ch.url;
        }
      }
    }

    function enterSingleMode() {
      btnSingle.classList.add("active");
      btnGrid.classList.remove("active");
      singleView.style.display = "block";
      gridView.style.display = "none";
      stopGrid();
    }

    // -------- GRID VIEW --------
    function buildGrid() {
      const wrapper = gridView.querySelector(".grid-wrapper");
      wrapper.innerHTML = "";

      for (let cell = 1; cell <= 4; cell++) {
        const div = document.createElement("div");
        div.className = "grid-cell";
        div.dataset.cell = cell;

        const header = document.createElement("div");
        header.className = "grid-header";

        const label = document.createElement("div");
        label.className = "grid-label";
        label.id = `label-cell-${cell}`;
        header.appendChild(label); // hidden via CSS but kept for structure

        const sel = document.createElement("select");
        sel.className = "grid-select";
        sel.dataset.cell = cell;

        Object.keys(CHANNELS).forEach(key => {
          const opt = document.createElement("option");
          opt.value = key;
          opt.textContent = CHANNELS[key].label;
          sel.appendChild(opt);
        });

        sel.addEventListener("change", (e) => {
          const c = parseInt(e.target.dataset.cell);
          playGridCell(c, e.target.value);
        });

        header.appendChild(sel);
        div.appendChild(header);

        // Body + frame
        const body = document.createElement("div");
        body.className = "grid-body";

        const frame = document.createElement("div");
        frame.className = "grid-frame";

        const vid = document.createElement("video");
        vid.id = `grid-video-${cell}`;
        vid.autoplay = true;
        vid.muted = true;
        vid.controls = true;
        vid.playsInline = true;
        vid.setAttribute("playsinline", "");

        const ytDiv = document.createElement("div");
        ytDiv.id = `grid-yt-${cell}`;
        ytDiv.className = "yt-container";
        ytDiv.style.display = "none";

        frame.appendChild(vid);
        frame.appendChild(ytDiv);
        body.appendChild(frame);
        div.appendChild(body);

        wrapper.appendChild(div);
      }
    }

    function stopGrid() {
      for (let k in hlsGrid) {
        if (hlsGrid[k]) {
          hlsGrid[k].destroy();
          hlsGrid[k] = null;
        }
      }

      // Destroy all grid YT players
      Object.keys(YT_PLAYERS).forEach((key) => {
        if (key.startsWith("grid-")) {
          destroyYTPlayer(key);
        }
      });

      for (let cell = 1; cell <= 4; cell++) {
        const v = document.getElementById(`grid-video-${cell}`);
        const y = document.getElementById(`grid-yt-${cell}`);
        if (v) {
          v.pause();
          v.removeAttribute("src");
          v.load();
          v.style.display = "block";
        }
        if (y) {
          y.innerHTML = "";
          y.style.display = "none";
        }
      }
    }

    function playGridCell(cell, key) {
      const ch = CHANNELS[key];
      const label = document.getElementById(`label-cell-${cell}`);
      const video = document.getElementById(`grid-video-${cell}`);
      const ytDiv = document.getElementById(`grid-yt-${cell}`);

      label.textContent = ch.label;

      // reset old
      if (hlsGrid[cell]) {
        hlsGrid[cell].destroy();
        hlsGrid[cell] = null;
      }
      video.pause();
      video.removeAttribute("src");
      video.load();

      destroyYTPlayer(`grid-${cell}`);
      ytDiv.innerHTML = "";

      if (ch.type === "yt") {
        video.style.display = "none";
        ytDiv.style.display = "flex";
        createOrReplaceYTPlayer(ytDiv, `grid-${cell}`, ch.url);
      } else {
        ytDiv.style.display = "none";
        video.style.display = "block";

        if (Hls.isSupported()) {
          const h = new Hls({ lowLatencyMode: true });
          h.loadSource(ch.url);
          h.attachMedia(video);
          hlsGrid[cell] = h;
        } else {
          video.src = ch.url;
        }
      }
    }

    function enterGridMode() {
      btnGrid.classList.add("active");
      btnSingle.classList.remove("active");

      singleView.style.display = "none";
      gridView.style.display = "block";

      stopSingle();

      for (let cell = 1; cell <= 4; cell++) {
        const defaultKey = GRID_DEFAULTS[cell];
        const selector = gridView.querySelector('select[data-cell="' + cell + '"]');
        if (selector) {
          selector.value = defaultKey;
        }
        playGridCell(cell, defaultKey);
      }
    }

    // -------- MODE BUTTON EVENTS --------
    btnSingle.addEventListener("click", enterSingleMode);
    btnGrid.addEventListener("click", enterGridMode);

    // -------- MOBILE CHANNEL DROPDOWN --------
    window.addEventListener('load', () => {
      const select = document.getElementById('channel-select-mobile');
      if (select && window.CHANNEL_ORDER && window.CHANNELS) {
        // Fill options
        CHANNEL_ORDER.forEach(key => {
          const ch = CHANNELS[key];
          if (!ch) return;
          const opt = document.createElement('option');
          opt.value = key;
          opt.textContent = ch.label;
          select.appendChild(opt);
        });

        select.addEventListener('change', (e) => {
          const key = e.target.value;
          if (!key) return;
          enterSingleMode();
          setSingleChannel(key);
        });
      }
    });

    // -------- INITIALIZE --------
    window.addEventListener("load", () => {
      buildGrid();
      setSingleChannel("cbs");
    });
  </script>

  <!-- TIME / WEATHER / INFO BAR (desktop) -->
  <script src="/config/time-config.js"></script>
  <script src="/config/weather-config.js"></script>
  <script src="/config/info-bar.js"></script>

  <!-- MOBILE TICKER: clone desktop footer into #info-bar-mobile -->
  <script>
    window.addEventListener('load', function () {
      const desktopBar = document.getElementById('info-bar');
      const mobileInner = document.getElementById('info-bar-mobile-inner');
      if (!desktopBar || !mobileInner) return;

      function startTickerWhenReady() {
        const content = desktopBar.innerHTML.trim();
        if (!content) {
          setTimeout(startTickerWhenReady, 1000);
          return;
        }
        mobileInner.innerHTML = content + ' \u00A0 \u00B7 \u00A0 ' + content;
        mobileInner.classList.add('ticker-running');
      }

      setTimeout(startTickerWhenReady, 2000);
    });
  </script>
</body>
</html>
<style>
@media (min-width: 769px) {
  /* Let the card show the full video instead of clipping the bottom */
  .grid-cell {
    overflow: visible !important;
  }

  /* Take a tiny bit of padding off the card so everything fits cleanly */
  .grid-frame {
    padding: 0.18rem !important;
  }
}
</style>
<style>
/* Hide the "Single" button everywhere (desktop + mobile) */
#btn-single {
  display: none !important;
}
</style>

<script>
window.addEventListener('load', function () {
  // If these exist, wrap enterGridMode so it clears the channel highlight
  if (typeof enterGridMode === 'function' && typeof highlightHeaderButton === 'function') {
    const originalEnterGridMode = enterGridMode;
    enterGridMode = function () {
      originalEnterGridMode();
      // Clear active state from all channel buttons (no single channel selected in grid)
      highlightHeaderButton("");
    };
  }
});
</script>
<script>
window.addEventListener('load', function () {
  if (typeof enterGridMode === 'function') {
    const originalEnterGridMode = enterGridMode;
    enterGridMode = function () {
      originalEnterGridMode();

      // After switching to grid, remove "active" from all channel buttons
      const container = document.getElementById('dynamic-buttons');
      if (container) {
        container.querySelectorAll('.btn').forEach(btn => {
          btn.classList.remove('active');
        });
      }
    };
  }
});
</script>
<script>
window.addEventListener('load', function () {
  // Track which mode we're in
  window._russellTVInGrid = false;

  // Wrap enterGridMode to set flag & clear highlights
  if (typeof enterGridMode === 'function') {
    const originalEnterGridMode = enterGridMode;
    enterGridMode = function () {
      window._russellTVInGrid = true;
      const result = originalEnterGridMode();

      // Clear active from all channel buttons when in grid
      const container = document.getElementById('dynamic-buttons');
      if (container) {
        container.querySelectorAll('.btn').forEach(btn => {
          btn.classList.remove('active');
        });
      }
      return result;
    };
  }

  // Wrap enterSingleMode to unset grid flag
  if (typeof enterSingleMode === 'function') {
    const originalEnterSingleMode = enterSingleMode;
    enterSingleMode = function () {
      window._russellTVInGrid = false;
      return originalEnterSingleMode();
    };
  }

  // Wrap highlightHeaderButton so it never highlights while in grid
  if (typeof highlightHeaderButton === 'function') {
    const originalHighlight = highlightHeaderButton;
    highlightHeaderButton = function (key) {
      // If we're in grid, do NOT highlight any header buttons
      if (window._russellTVInGrid) {
        const container = document.getElementById('dynamic-buttons');
        if (container) {
          container.querySelectorAll('.btn').forEach(btn => {
            btn.classList.remove('active');
          });
        }
        return;
      }
      // Normal behavior in single view
      originalHighlight(key);
    };
  }
});
</script>
<style>
/* Hide the Single View button (you no longer want it) */
#btn-single {
  display: none !important;
}
</style>

<script>
// Run AFTER absolutely everything is initialized
window.addEventListener('load', function () {
  setTimeout(() => {
    const channelButtons = () =>
      Array.from(document.querySelectorAll('#dynamic-buttons .btn'));

    // SAFETY: Ensure functions exist
    if (!window.enterGridMode || !window.enterSingleMode || !window.highlightHeaderButton) {
      console.warn("RussellTV patch: functions not ready.");
      return;
    }

    // --- Wrap highlight function so it ONLY works in single view ---
    let inGrid = false;

    const originalHighlight = window.highlightHeaderButton;
    window.highlightHeaderButton = function (key) {
      if (inGrid) {
        // Clear highlights instead of applying any
        channelButtons().forEach(btn => btn.classList.remove('active'));
        return;
      }

      // Normal behavior in single mode
      originalHighlight(key);
    };

    // --- Patch Grid Mode so it ALWAYS clears highlights ---
    const originalGrid = window.enterGridMode;
    window.enterGridMode = function () {
      inGrid = true;
      originalGrid();

      // Remove all active highlights immediately
      channelButtons().forEach(btn => btn.classList.remove('active'));
    };

    // --- Patch Single Mode so highlight works normally ---
    const originalSingle = window.enterSingleMode;
    window.enterSingleMode = function () {
      inGrid = false;
      originalSingle();
    };

  }, 200); // Delay ensures all functions have been defined
});
</script>
