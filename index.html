<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Russell TV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/favicon.png">

  <style>
    /* ---------- Base Layout ---------- */
    body {
      margin: 0;
      padding: 0;
      background: url("/background.png") no-repeat center center fixed;
      background-size: cover;
      background-color: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #fff;
    }

    header {
      background: rgba(0,0,0,0.8);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }

    .mode-toggle {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.26);
      background: rgba(0,0,0,0.7);
      color: #fff;
      font-size: 0.85rem;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.25s ease, box-shadow 0.25s ease,
                  transform 0.12s ease, border-color 0.25s ease;
    }

    .btn:hover {
      background: linear-gradient(90deg, rgba(255,80,0,0.25), rgba(255,150,0,0.25));
      box-shadow: 0 0 8px rgba(255,120,0,0.6), 0 0 12px rgba(255,80,0,0.4);
      transform: translateY(-1px);
    }

    .btn.active {
      background: linear-gradient(90deg, rgba(255,80,0,0.4), rgba(255,150,0,0.4));
      box-shadow: 0 0 10px rgba(255,120,0,0.8), 0 0 14px rgba(255,80,0,0.6);
      border-color: rgba(255,180,0,0.9);
      transform: translateY(-1px);
    }

    main {
      padding: 0.75rem;
      padding-bottom: 2.2rem; /* room for footer */
      box-sizing: border-box;
    }

    #single-view,
    #grid-view {
      box-sizing: border-box;
    }

    /* ---------- Single View ---------- */
    .single-layout {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
    }

    .single-video-card {
      flex: 0 1 70%;
      max-width: 960px;
      background: rgba(0,0,0,0.6);
      border-radius: 12px;
      padding: 0.5rem;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    #single-player-hls,
    #single-player-yt {
      width: 100%;
      max-width: 100%;
      aspect-ratio: 16 / 9;
      height: auto;
      display: none;
      border-radius: 12px;
      background: #000;
      border: none;
    }

    .single-side-panel {
      flex: 1;
      min-height: 200px;
      border-radius: 12px;
      border: 1px dashed rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.35);
      box-sizing: border-box;
      padding: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      overflow-y: auto;
      max-height: 80vh;
    }

    /* ---------- Headlines Sidebar ---------- */
    .headline-section {
      border-radius: 8px;
      padding: 0.5rem 0.6rem;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.12);
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .headline-section h3 {
      margin: 0 0 0.25rem 0;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.85;
    }

    .headline-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      font-size: 0.9rem;
    }

    .headline-item {
      margin: 1px 0;
      padding: 0;
      list-style: none;
      background: transparent;
      border: 0;
      box-shadow: none;
    }

    .headline-item a {
      display: block;
      padding: 4px 6px;
      border-radius: 8px;
      text-decoration: none;
      color: inherit;
      font-size: 0.95rem;
      line-height: 1.25;
      background: rgba(0,0,0,0.45);
      transition: background 0.25s ease, box-shadow 0.25s ease,
                  transform 0.12s ease;
    }

    .headline-item a:hover {
      background: linear-gradient(90deg, rgba(255,80,0,0.3), rgba(255,150,0,0.3));
      box-shadow: 0 0 8px rgba(255,120,0,0.7), 0 0 12px rgba(255,80,0,0.5);
      transform: translateX(3px);
      cursor: pointer;
    }

    .headline-title {
      font-weight: 600;
      font-size: 0.98rem;
      margin: 0 0 1px 0;
      line-height: 1.25;
    }

    .headline-meta {
      font-size: 0.8rem;
      line-height: 1.2;
      margin: 0;
      opacity: 0.8;
    }

    .headline-empty,
    .headline-error {
      font-size: 0.8rem;
      opacity: 0.7;
      font-style: italic;
    }

    /* ---------- Grid View ---------- */
    #grid-view {
      display: none;
    }

    .grid-wrapper {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-auto-rows: auto;
      gap: 0.75rem;
      height: auto;
    }

    .grid-cell {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
      background: transparent;
      border-radius: 12px;
      overflow: hidden;
    }

    .grid-header {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.5rem;
      padding: 0.15rem 0.5rem 0 0.5rem;
      box-sizing: border-box;
    }

    .grid-label {
      display: none; /* kept for future use if needed */
    }

    .grid-select {
      font-size: 0.75rem;
      background: rgba(0,0,0,0.8);
      color: #fff;
      border-radius: 999px;
      border: 1px solid #ffffff44;
      padding: 0.25rem 0.55rem;
      cursor: pointer;
    }

    .grid-body {
      flex: 1 1 auto;
      padding: 0.25rem 0.5rem 0.5rem;
      box-sizing: border-box;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .grid-frame {
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.15);
      border-radius: 12px;
      padding: 0.18rem;
      box-sizing: border-box;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .grid-frame > video,
    .grid-frame > .yt-container,
    .grid-frame > iframe {
      width: 100%;
      max-width: 100%;
      aspect-ratio: 16 / 9;
      height: auto;
      object-fit: contain;
      background: #000;
      border-radius: 8px;
    }

    .yt-container {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
    }

    .yt-container iframe {
      width: 100%;
      height: 100%;
      border-radius: 8px;
      border: none;
      background: #000;
    }

    /* ---------- Info Bar (desktop) ---------- */
    #info-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      color: #fff;
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
      box-sizing: border-box;
      z-index: 1000;
      overflow: hidden;
    }

    /* Mobile cloned ticker bar */
    #info-bar-mobile {
      display: none;
    }

    #info-bar-mobile-inner {
      display: inline-flex;
      flex-wrap: nowrap;
      align-items: flex-start;
      gap: 1.2rem;
      white-space: nowrap;
    }

    #info-bar-mobile-inner.ticker-running {
      animation: infoBarTicker 70s linear infinite;
    }

    #info-bar-mobile-inner > * {
      display: inline-flex;
      flex-direction: column;
      padding: 0 0.35rem;
      margin: 0;
    }

    #info-bar-mobile-inner br {
      display: inline;
    }

    #info-bar-mobile:hover #info-bar-mobile-inner {
      animation-play-state: paused;
    }

    @keyframes infoBarTicker {
      0%   { transform: translateX(0%); }
      100% { transform: translateX(-100%); }
    }

    /* ---------- Channel controls: desktop vs mobile ---------- */
    .channel-select-mobile-wrapper {
      display: none;
    }

    /* Hide Single button visually (we still use its JS, but user only sees Grid) */
    #btn-single {
      display: none !important;
    }

    /* ---------- Mobile ---------- */
    @media (max-width: 768px) {
      body {
        background-attachment: scroll;
      }

      main {
        padding: 0.5rem;
        padding-bottom: 2rem;
      }

      .btn {
        font-size: 0.8rem;
        padding: 0.3rem 0.7rem;
      }

      .single-layout {
        flex-direction: column;
      }

      .single-video-card {
        flex: 1 1 auto;
        max-width: 100%;
      }

      .single-side-panel {
        width: 100%;
        min-height: 120px;
        max-height: none;
      }

      .grid-wrapper {
        grid-template-columns: 1fr;
        height: auto;
      }

      #single-player-hls,
      #single-player-yt {
        max-height: 60vh;
      }

      /* Header as simple grid: title full-width, controls row below */
      header {
        display: grid;
        grid-template-columns: 1fr auto;
        grid-template-rows: auto auto;
        align-items: center;
        column-gap: 0.5rem;
        padding: 0.5rem 0.75rem;
      }

      header h1 {
        grid-column: 1 / span 2;
        font-size: 1rem;
        margin-bottom: 0.25rem;
      }

      /* Mobile dropdown row */
      .channel-select-mobile-wrapper {
        grid-column: 1 / 2;
        display: block;
      }

      .channel-select-mobile {
        background: rgba(0,0,0,0.8);
        color: #fff;
        border-radius: 999px;
        border: 1px solid #ffffff44;
        padding: 0.3rem 0.7rem;
        font-size: 0.8rem;
        width: 100%;
      }

      /* Hide desktop per-channel buttons on mobile */
      #dynamic-buttons {
        display: none !important;
      }

      /* Grid button row */
      header .mode-toggle:last-child {
        grid-column: 2 / 3;
        display: flex;
        justify-content: flex-end;
        margin: 0;
      }

      #btn-grid {
        display: inline-block !important;
        white-space: nowrap;
      }

      /* Hide desktop info bar, show mobile ticker */
      #info-bar {
        display: none !important;
      }

      #info-bar-mobile {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.9);
        color: #fff;
        font-size: 0.6rem;
        height: 2.4rem;
        padding: 0.25rem 0.35rem;
        box-sizing: border-box;
        z-index: 1000;
        overflow: hidden;
        display: block;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>Russell TV</h1>

    <!-- Mobile channel dropdown -->
    <div class="channel-select-mobile-wrapper">
      <select id="channel-select-mobile" class="channel-select-mobile">
        <option value="">Select channel</option>
      </select>
    </div>

    <!-- Desktop channel buttons -->
    <div id="dynamic-buttons" class="mode-toggle"></div>

    <!-- Mode toggle -->
    <div class="mode-toggle">
      <button id="btn-single" class="btn active">Single</button>
      <button id="btn-grid" class="btn">Grid (4)</button>
    </div>
  </header>

  <main>
    <!-- SINGLE VIEW -->
    <section id="single-view">
      <div class="single-layout">
        <div class="single-video-card">
          <video id="single-player-hls" controls autoplay muted playsinline></video>
          <div id="single-player-yt" style="display:none;"></div>
        </div>

        <aside class="single-side-panel" id="single-side-panel">
          <section class="headline-section">
            <h3 id="channel-headlines-title">Channel Headlines</h3>
            <div class="headline-meta" id="channel-headlines-updated"></div>
            <ul class="headline-list" id="channel-headlines-list">
              <li class="headline-empty">Select a channel to load headlines…</li>
            </ul>
          </section>

          <section class="headline-section">
            <h3>Marine Corps News</h3>
            <div class="headline-meta" id="marines-headlines-updated"></div>
            <ul class="headline-list" id="marines-headlines-list">
              <li class="headline-empty">Loading Marine Corps news…</li>
            </ul>
          </section>
        </aside>
      </div>
    </section>

    <!-- GRID VIEW -->
    <section id="grid-view">
      <div class="grid-wrapper">
        <!-- Cells built dynamically -->
      </div>
    </section>
  </main>

  <!-- Mobile info-bar clone; desktop #info-bar is injected by info-bar.js -->
  <div id="info-bar-mobile">
    <div id="info-bar-mobile-inner"></div>
  </div>

  <!-- CONFIG -->
  <script src="/config/channels.js"></script>

  <!-- HLS.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <!-- YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    // Core DOM refs
    const singleView = document.getElementById("single-view");
    const gridView   = document.getElementById("grid-view");
    const singleHLS  = document.getElementById("single-player-hls");
    const singleYTContainer = document.getElementById("single-player-yt");

    const btnSingle = document.getElementById("btn-single");
    const btnGrid   = document.getElementById("btn-grid");

    const headerBtnContainer = document.getElementById("dynamic-buttons");

    let hlsSingle = null;
    const hlsGrid = {};         // cell -> Hls instance
    const YT_PLAYERS = {};      // key -> YT.Player

    function onYouTubeIframeAPIReady() {
      // Defined for API; players created lazily
    }

    function getYouTubeVideoId(url) {
      if (!url) return null;
      const idx = url.indexOf("/embed/");
      if (idx === -1) return null;
      let idPart = url.substring(idx + 7);
      const qIdx = idPart.indexOf("?");
      if (qIdx !== -1) idPart = idPart.substring(0, qIdx);
      return idPart;
    }

    function destroyYTPlayer(playerKey) {
      if (YT_PLAYERS[playerKey]) {
        try {
          YT_PLAYERS[playerKey].destroy();
        } catch (e) {
          console.warn("Error destroying YT player", playerKey, e);
        }
        delete YT_PLAYERS[playerKey];
      }
    }

    function createOrReplaceYTPlayer(container, playerKey, videoUrl) {
      const videoId = getYouTubeVideoId(videoUrl);
      if (!videoId) {
        console.warn("Could not parse YouTube video ID from URL:", videoUrl);
        return;
      }

      destroyYTPlayer(playerKey);

      container.innerHTML = "";
      const innerId = playerKey + "-inner";
      const inner = document.createElement("div");
      inner.id = innerId;
      inner.style.width = "100%";
      inner.style.height = "100%";
      container.appendChild(inner);

      function build() {
        if (window.YT && typeof YT.Player === "function") {
          const player = new YT.Player(innerId, {
            videoId: videoId,
            playerVars: {
              autoplay: 1,
              mute: 1,
              controls: 1,
              rel: 0,
              playsinline: 1
            },
            events: {
              onReady: (e) => {
                e.target.setPlaybackQuality("large");
              },
              onStateChange: (e) => {
                if (e.data === YT.PlayerState.PLAYING) {
                  e.target.setPlaybackQuality("large");
                }
              }
            }
          });
          YT_PLAYERS[playerKey] = player;
        } else {
          setTimeout(build, 100);
        }
      }

      build();
    }

    // ---------- Channel Buttons (desktop) ----------
    function buildChannelButtons() {
      if (!window.CHANNEL_ORDER || !window.CHANNELS) return;
      headerBtnContainer.innerHTML = "";

      window.CHANNEL_ORDER.forEach(key => {
        const ch = window.CHANNELS[key];
        if (!ch) return;

        const btn = document.createElement("button");
        btn.id = "btn-" + key;
        btn.className = "btn";
        btn.textContent = ch.label;

        btn.addEventListener("click", () => {
          enterSingleMode();
          setSingleChannel(key);
        });

        headerBtnContainer.appendChild(btn);
      });
    }

    function clearHeaderHighlights() {
      headerBtnContainer
        .querySelectorAll(".btn")
        .forEach(b => b.classList.remove("active"));
    }

    function highlightHeaderButton(key) {
      clearHeaderHighlights();
      if (!key) return;
      const btn = document.getElementById("btn-" + key);
      if (btn) btn.classList.add("active");
    }

    // ---------- Single View ----------
    function stopSingle() {
      if (hlsSingle) {
        hlsSingle.destroy();
        hlsSingle = null;
      }
      singleHLS.pause();
      singleHLS.removeAttribute("src");
      singleHLS.load();

      destroyYTPlayer("single");
      singleYTContainer.innerHTML = "";
      singleYTContainer.style.display = "none";
      singleHLS.style.display = "block";
    }

    function setSingleChannel(key) {
      const ch = window.CHANNELS[key];
      if (!ch) return;

      highlightHeaderButton(key);

      // Sync mobile dropdown
      const mobileSelect = document.getElementById("channel-select-mobile");
      if (mobileSelect) {
        mobileSelect.value = key;
      }

      // Stop any grid playback
      stopGrid();
      // Stop current single playback
      stopSingle();

      // Call into news.js for channel headlines if available
      try {
        if (window.loadChannelHeadlines && window.CHANNELS[key]) {
          window.loadChannelHeadlines(key, window.CHANNELS[key].label || key);
        }
      } catch (e) {
        console.warn("loadChannelHeadlines threw:", e);
      }

      if (ch.type === "yt") {
        singleHLS.style.display = "none";
        singleYTContainer.style.display = "block";
        createOrReplaceYTPlayer(singleYTContainer, "single", ch.url);
      } else {
        singleYTContainer.style.display = "none";
        singleHLS.style.display = "block";

        if (window.Hls && Hls.isSupported()) {
          hlsSingle = new Hls({ lowLatencyMode: true });
          hlsSingle.loadSource(ch.url);
          hlsSingle.attachMedia(singleHLS);
        } else {
          singleHLS.src = ch.url;
        }
      }
    }

    function enterSingleMode() {
      btnSingle.classList.add("active");
      btnGrid.classList.remove("active");
      singleView.style.display = "block";
      gridView.style.display = "none";
      // In single mode, channel buttons can be highlighted
    }

    // ---------- Grid View ----------
    function buildGrid() {
      const wrapper = gridView.querySelector(".grid-wrapper");
      if (!wrapper) return;
      wrapper.innerHTML = "";

      for (let cell = 1; cell <= 4; cell++) {
        const div = document.createElement("div");
        div.className = "grid-cell";
        div.dataset.cell = cell;

        const header = document.createElement("div");
        header.className = "grid-header";

        const label = document.createElement("div");
        label.className = "grid-label";
        label.id = "label-cell-" + cell;
        header.appendChild(label);

        const sel = document.createElement("select");
        sel.className = "grid-select";
        sel.dataset.cell = cell;

        Object.keys(window.CHANNELS || {}).forEach(key => {
          const opt = document.createElement("option");
          opt.value = key;
          opt.textContent = window.CHANNELS[key].label;
          sel.appendChild(opt);
        });

        sel.addEventListener("change", (e) => {
          const c = parseInt(e.target.dataset.cell, 10);
          playGridCell(c, e.target.value);
        });

        header.appendChild(sel);
        div.appendChild(header);

        const body = document.createElement("div");
        body.className = "grid-body";

        const frame = document.createElement("div");
        frame.className = "grid-frame";

        const vid = document.createElement("video");
        vid.id = "grid-video-" + cell;
        vid.autoplay = true;
        vid.muted = true;
        vid.controls = true;
        vid.playsInline = true;
        vid.setAttribute("playsinline", "");

        const ytDiv = document.createElement("div");
        ytDiv.id = "grid-yt-" + cell;
        ytDiv.className = "yt-container";
        ytDiv.style.display = "none";

        frame.appendChild(vid);
        frame.appendChild(ytDiv);
        body.appendChild(frame);
        div.appendChild(body);

        wrapper.appendChild(div);
      }
    }

    function stopGrid() {
      for (let k in hlsGrid) {
        if (hlsGrid[k]) {
          hlsGrid[k].destroy();
          hlsGrid[k] = null;
        }
      }

      Object.keys(YT_PLAYERS).forEach((key) => {
        if (key.startsWith("grid-")) {
          destroyYTPlayer(key);
        }
      });

      for (let cell = 1; cell <= 4; cell++) {
        const v = document.getElementById("grid-video-" + cell);
        const y = document.getElementById("grid-yt-" + cell);
        if (v) {
          v.pause();
          v.removeAttribute("src");
          v.load();
          v.style.display = "block";
        }
        if (y) {
          y.innerHTML = "";
          y.style.display = "none";
        }
      }
    }

    function playGridCell(cell, key) {
      const ch = window.CHANNELS[key];
      if (!ch) return;

      const label = document.getElementById("label-cell-" + cell);
      const video = document.getElementById("grid-video-" + cell);
      const ytDiv = document.getElementById("grid-yt-" + cell);

      if (label) label.textContent = ch.label;

      if (hlsGrid[cell]) {
        hlsGrid[cell].destroy();
        hlsGrid[cell] = null;
      }

      video.pause();
      video.removeAttribute("src");
      video.load();

      destroyYTPlayer("grid-" + cell);
      ytDiv.innerHTML = "";

      if (ch.type === "yt") {
        video.style.display = "none";
        ytDiv.style.display = "flex";
        createOrReplaceYTPlayer(ytDiv, "grid-" + cell, ch.url);
      } else {
        ytDiv.style.display = "none";
        video.style.display = "block";

        if (window.Hls && Hls.isSupported()) {
          const h = new Hls({ lowLatencyMode: true });
          h.loadSource(ch.url);
          h.attachMedia(video);
          hlsGrid[cell] = h;
        } else {
          video.src = ch.url;
        }
      }
    }

    function enterGridMode() {
      btnGrid.classList.add("active");
      btnSingle.classList.remove("active");

      singleView.style.display = "none";
      gridView.style.display = "block";

      stopSingle();

      // In grid mode, no channel button should look selected
      clearHeaderHighlights();

      for (let cell = 1; cell <= 4; cell++) {
        const defaultKey = window.GRID_DEFAULTS && window.GRID_DEFAULTS[cell];
        if (!defaultKey) continue;

        const selector = gridView.querySelector('select[data-cell="' + cell + '"]');
        if (selector) {
          selector.value = defaultKey;
        }
        playGridCell(cell, defaultKey);
      }
    }

    // ---------- Mode Buttons ----------
    btnSingle.addEventListener("click", enterSingleMode);
    btnGrid.addEventListener("click", enterGridMode);

    // ---------- Mobile channel dropdown ----------
    function initMobileChannelSelect() {
      const select = document.getElementById("channel-select-mobile");
      if (!select || !window.CHANNEL_ORDER || !window.CHANNELS) return;

      window.CHANNEL_ORDER.forEach(key => {
        const ch = window.CHANNELS[key];
        if (!ch) return;
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = ch.label;
        select.appendChild(opt);
      });

      select.addEventListener("change", (e) => {
        const key = e.target.value;
        if (!key) return;
        enterSingleMode();
        setSingleChannel(key);
      });
    }

    // ---------- Mobile ticker: clone info-bar ----------
    function initMobileTicker() {
      const desktopBar = document.getElementById("info-bar");
      const mobileInner = document.getElementById("info-bar-mobile-inner");
      if (!desktopBar || !mobileInner) return;

      function startTickerWhenReady() {
        const content = desktopBar.innerHTML.trim();
        if (!content) {
          setTimeout(startTickerWhenReady, 1000);
          return;
        }
        mobileInner.innerHTML = content + " \u00A0 \u00B7 \u00A0 " + content;
        mobileInner.classList.add("ticker-running");
      }

      setTimeout(startTickerWhenReady, 2000);
    }

    // ---------- Initialize on load ----------
    window.addEventListener("load", () => {
      buildChannelButtons();
      buildGrid();
      initMobileChannelSelect();

      // Default to first channel in order, or CBS if present
      let initialChannel = "cbs";
      if (window.CHANNEL_ORDER && window.CHANNEL_ORDER.length > 0) {
        initialChannel = window.CHANNEL_ORDER[0];
      }

      enterSingleMode();
      setSingleChannel(initialChannel);

      initMobileTicker();
    });
  </script>

  <!-- TIME / WEATHER / INFO BAR (desktop) -->
  <script src="/config/time-config.js"></script>
  <script src="/config/weather-config.js"></script>
  <script src="/config/info-bar.js"></script>

  <!-- NEWS CONFIG + LOGIC (external) -->
  <script src="/config/news-config.js"></script>
  <script src="/js/news.js"></script>
<script>
  // --- RussellTV: Remember last channel + view using localStorage ---

  const RT_STORAGE = {
    channel: "russelltv.lastChannel",
    view: "russelltv.lastView",
  };

  function rtSaveLastChannel(id) {
    try {
      localStorage.setItem(RT_STORAGE.channel, id);
    } catch (e) {
      // ignore if storage not available
    }
  }

  function rtSaveLastView(view) {
    try {
      localStorage.setItem(RT_STORAGE.view, view);
    } catch (e) {
      // ignore if storage not available
    }
  }

  function rtLoadLastChannel() {
    try {
      return localStorage.getItem(RT_STORAGE.channel);
    } catch (e) {
      return null;
    }
  }

  function rtLoadLastView() {
    try {
      return localStorage.getItem(RT_STORAGE.view);
    } catch (e) {
      return null;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const channelButtons = document.querySelectorAll("[data-channel-id]");
    const singleBtn = document.querySelector('[data-view="single"]');
    const gridBtn = document.querySelector('[data-view="grid"]');

    // 1. Whenever user clicks a channel, remember that channel
    channelButtons.forEach((btn) => {
      const id = btn.dataset.channelId;
      if (!id) return;

      btn.addEventListener("click", () => {
        rtSaveLastChannel(id);
        // clicking a channel implies single view is active
        rtSaveLastView("single");
      });
    });

    // 2. Whenever user switches view, remember "single" or "grid"
    if (singleBtn) {
      singleBtn.addEventListener("click", () => {
        rtSaveLastView("single");
      });
    }

    if (gridBtn) {
      gridBtn.addEventListener("click", () => {
        rtSaveLastView("grid");
      });
    }

    // 3. Restore last view + channel on load
    const savedView = rtLoadLastView();
    const savedChannel = rtLoadLastChannel();

    const viewToUse =
      savedView === "grid" || savedView === "single" ? savedView : "single";

    // Helper: click a button only if it exists
    function safeClick(btn) {
      if (btn && typeof btn.click === "function") {
        btn.click();
        return true;
      }
      return false;
    }

    // If last view was grid, go straight to grid
    if (viewToUse === "grid") {
      safeClick(gridBtn);

      // Still remember last single-channel selection for when they switch back
      if (savedChannel) {
        rtSaveLastChannel(savedChannel);
      }
    } else {
      // Default / saved single view
      safeClick(singleBtn);

      // If we have a saved channel, click its button
      if (savedChannel) {
        const chanBtn = document.querySelector(
          `[data-channel-id="${savedChannel}"]`
        );
        if (!safeClick(chanBtn)) {
          // fallback to first channel button if saved one doesn't exist
          if (channelButtons.length > 0) {
            safeClick(channelButtons[0]);
          }
        }
      } else {
        // No saved channel -> just click first one as default (e.g. CBS)
        if (channelButtons.length > 0) {
          safeClick(channelButtons[0]);
          const firstId = channelButtons[0].dataset.channelId;
          if (firstId) {
            rtSaveLastChannel(firstId);
          }
        }
      }
    }
  });
</script>
</body>
</html>
