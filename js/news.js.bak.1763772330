(function () {
  const cfg = window.CHANNEL_NEWS_CONFIG || {};

  const titleEl        = document.getElementById("channel-headlines-title");
  const channelListEl  = document.getElementById("channel-headlines-list");
  const marinesListEl  = document.getElementById("marines-headlines-list");

  function setStatus(ul, text) {
    if (!ul) return;
    ul.innerHTML = "";
    const li = document.createElement("li");
    li.className = "headline-empty";
    li.textContent = text;
    ul.appendChild(li);
  }

  function renderArticles(ul, articles, emptyText) {
    if (!ul) return;

    ul.innerHTML = "";

    if (!articles || !articles.length) {
      setStatus(ul, emptyText || "No headlines available.");
      return;
    }

    articles.slice(0, 8).forEach(a => {
      const li = document.createElement("li");
      li.className = "headline-item";

      const link = document.createElement("a");
      link.href = a.url || "#";
      link.target = "_blank";
      link.rel = "noopener noreferrer";
      link.textContent = a.title || "Untitled";

      const meta = document.createElement("div");
      meta.className = "headline-meta";

      const sourceBits = [];
      if (a.source && a.source.name) {
        sourceBits.push(a.source.name);
      }
      if (a.publishedAt) {
        const d = new Date(a.publishedAt);
        if (!isNaN(d.getTime())) {
          sourceBits.push(d.toLocaleString(undefined, {
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit"
          }));
        }
      }
      if (sourceBits.length) {
        meta.textContent = sourceBits.join(" \u2022 ");
      }

      li.appendChild(link);
      if (sourceBits.length) {
        li.appendChild(meta);
      }

      ul.appendChild(li);
    });
  }

  async function loadFromCache(cacheFile, ul, emptyText) {
    if (!ul || !cacheFile) return;

    setStatus(ul, "Loading headlinesâ€¦");

    try {
      const resp = await fetch(cacheFile + "?t=" + Date.now());
      if (!resp.ok) {
        throw new Error("HTTP " + resp.status);
      }
      const data = await resp.json();
      const articles = data && data.articles ? data.articles : [];
      renderArticles(ul, articles, emptyText);
    } catch (err) {
      console.error("Error loading", cacheFile, err);
      setStatus(ul, "Error loading headlines.");
    }
  }

  function loadChannelHeadlines(channelKey) {
    if (!channelListEl) return;

    const entry = cfg[channelKey];
    if (!entry) {
      if (titleEl) {
        titleEl.textContent = "Channel Headlines";
      }
      setStatus(channelListEl, "No headlines configured for this channel.");
      return;
    }

    if (titleEl) {
      titleEl.textContent = entry.label || "Channel Headlines";
    }

    loadFromCache(entry.cacheFile, channelListEl, "No headlines for this channel.");
  }

  function loadMarines() {
    const entry = cfg.marines;
    if (!entry || !marinesListEl) return;
    loadFromCache(entry.cacheFile, marinesListEl, "No Marine Corps news at the moment.");
  }

  // Expose for debugging if you want to trigger manually from console.
  window.loadChannelHeadlines = loadChannelHeadlines;
  window.loadMarinesHeadlines = loadMarines;

  // --- Hook into your existing setSingleChannel() without editing index.html ---
  if (typeof window.setSingleChannel === "function") {
    const original = window.setSingleChannel;
    window.setSingleChannel = function (key) {
      original(key);
      try {
        loadChannelHeadlines(key);
      } catch (e) {
        console.error("Error updating headlines for channel", key, e);
      }
    };
  }

  // Load Marine Corps news on page load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", loadMarines);
  } else {
    loadMarines();
  }
})();
