(function () {
  const cfg = window.CHANNEL_NEWS_CONFIG || {};

  function byId(id) {
    return document.getElementById(id);
  }

  const channelTitleEl = byId("channel-headlines-title");
  const channelListEl  = byId("channel-headlines-list");
  let channelUpdatedEl = null;

  const marinesListEl  = byId("marines-headlines-list");
  let marinesTitleEl   = null;
  let marinesUpdatedEl = null;

  if (marinesListEl) {
    const prev = marinesListEl.previousElementSibling;
    if (prev && prev.tagName === "H3") {
      marinesTitleEl = prev;
    }
  }

  function ensureUpdatedEl(kind) {
    if (kind === "channel") {
      if (!channelTitleEl) return null;
      if (!channelUpdatedEl) {
        channelUpdatedEl = document.createElement("div");
        channelUpdatedEl.id = "channel-headlines-updated";
        channelUpdatedEl.className = "headline-updated";
        channelTitleEl.insertAdjacentElement("afterend", channelUpdatedEl);
      }
      return channelUpdatedEl;
    }
    if (kind === "marines") {
      if (!marinesTitleEl) return null;
      if (!marinesUpdatedEl) {
        marinesUpdatedEl = document.createElement("div");
        marinesUpdatedEl.id = "marines-headlines-updated";
        marinesUpdatedEl.className = "headline-updated";
        marinesTitleEl.insertAdjacentElement("afterend", marinesUpdatedEl);
      }
      return marinesUpdatedEl;
    }
    return null;
  }

  function clearList(ul) {
    if (!ul) return;
    while (ul.firstChild) {
      ul.removeChild(ul.firstChild);
    }
  }

  function formatDate(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (isNaN(d.getTime())) return "";
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const h = d.getHours();
    const m = d.getMinutes();
    const ampm = h >= 12 ? "PM" : "AM";
    const hh = ((h + 11) % 12) + 1;
    const mm = (m < 10 ? "0" : "") + m;
    return `${months[d.getMonth()]} ${d.getDate()}, ${hh}:${mm} ${ampm}`;
  }

  function formatTimeOrDate(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (isNaN(d.getTime())) return "";
    const now = new Date();
    const sameDay = d.toDateString() === now.toDateString();
    const h = d.getHours();
    const m = d.getMinutes();
    const ampm = h >= 12 ? "PM" : "AM";
    const hh = ((h + 11) % 12) + 1;
    const mm = (m < 10 ? "0" : "") + m;
    if (sameDay) {
      return `${hh}:${mm} ${ampm}`;
    }
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return `${months[d.getMonth()]} ${d.getDate()}`;
  }

  function renderArticles(ul, data, opts) {
    if (!ul) return;
    clearList(ul);
    opts = opts || {};
    const updatedEl    = opts.updatedEl;
    const fallbackName = opts.titlePrefix || "";

    if (!data || data.status !== "ok") {
      const li = document.createElement("li");
      li.className = "headline-error";
      li.textContent = "Error loading headlines.";
      ul.appendChild(li);
      if (updatedEl) updatedEl.textContent = "";
      return;
    }

    if (updatedEl && data.fetchedAt) {
      const formatted = formatDate(data.fetchedAt);
      updatedEl.textContent = formatted ? `Last updated: ${formatted}` : "";
    }

    const articles = Array.isArray(data.articles) ? data.articles : [];
    if (!articles.length) {
      const li = document.createElement("li");
      li.className = "headline-empty";
      li.textContent = "No headlines found for this channel.";
      ul.appendChild(li);
      return;
    }

    articles.forEach((a) => {
      const li   = document.createElement("li");
      li.className = "headline-item";

      const link = document.createElement("a");
      link.className = "headline-link";
      link.href = a.url || "#";
      link.target = "_blank";
      link.rel = "noopener noreferrer";

      const titleDiv = document.createElement("div");
      titleDiv.className = "headline-title";
      titleDiv.textContent = a.title || "(no title)";

      const srcFromArticle =
        a && a.source && a.source.name ? a.source.name : "";
      const src = srcFromArticle || fallbackName;
      const when = formatTimeOrDate(a.publishedAt);

      const metaDiv = document.createElement("div");
      metaDiv.className = "headline-meta";
      if (src && when) {
        metaDiv.textContent = `${src} • ${when}`;
      } else if (src) {
        metaDiv.textContent = src;
      } else {
        metaDiv.textContent = when;
      }

      link.appendChild(titleDiv);
      if (metaDiv.textContent) {
        link.appendChild(metaDiv);
      }

      if (a.description) {
        const descDiv = document.createElement("div");
        descDiv.className = "headline-desc";
        descDiv.textContent = a.description;
        link.appendChild(descDiv);
      }

      li.appendChild(link);
      ul.appendChild(li);
    });
  }

  function fetchJson(path, cb) {
    fetch(path)
      .then((resp) => {
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        return resp.json();
      })
      .then((data) => cb(null, data))
      .catch((err) => cb(err));
  }

  window.loadChannelHeadlines = function (channelKey, channelLabel) {
    if (!channelListEl || !channelTitleEl) return;

    const cfgEntry = cfg[channelKey];
    clearList(channelListEl);
    const updatedEl = ensureUpdatedEl("channel");

    if (!cfgEntry || !cfgEntry.file) {
      const li = document.createElement("li");
      li.className = "headline-error";
      li.textContent = "No headline config for this channel.";
      channelListEl.appendChild(li);
      if (updatedEl) updatedEl.textContent = "";
      return;
    }

    channelTitleEl.textContent =
      cfgEntry.label || `Channel Headlines – ${channelLabel || channelKey}`;
    if (updatedEl) updatedEl.textContent = "Loading…";

    const url = `/news-cache/${cfgEntry.file}?v=${Date.now()}`;
    fetchJson(url, (err, data) => {
      if (err) {
        console.error("channel headlines error", err);
        const li = document.createElement("li");
        li.className = "headline-error";
        li.textContent = "Error loading headlines.";
        clearList(channelListEl);
        channelListEl.appendChild(li);
        if (updatedEl) updatedEl.textContent = "";
        return;
      }
      renderArticles(channelListEl, data, {
        updatedEl,
        titlePrefix: cfgEntry.sourceName || "",
      });
    });
  };

  window.loadMarinesHeadlines = function () {
    if (!marinesListEl) return;
    const updatedEl = ensureUpdatedEl("marines");

    clearList(marinesListEl);
    if (updatedEl) updatedEl.textContent = "Loading…";

    const url = `/news-cache/marines.json?v=${Date.now()}`;
    fetchJson(url, (err, data) => {
      if (err) {
        console.error("marines headlines error", err);
        const li = document.createElement("li");
        li.className = "headline-error";
        li.textContent = "Error loading headlines.";
        clearList(marinesListEl);
        marinesListEl.appendChild(li);
        if (updatedEl) updatedEl.textContent = "";
        return;
      }
      renderArticles(marinesListEl, data, {
        updatedEl,
        titlePrefix: "",  // <- no "United States Marine Corps" spam
      });
    });
  };

  function initNews() {
    try {
      if (window.loadMarinesHeadlines) {
        window.loadMarinesHeadlines();
      }

      if (!window.CHANNELS || !window.CHANNEL_ORDER) {
        return;
      }

      window.CHANNEL_ORDER.forEach((key) => {
        const btn = document.getElementById(`btn-${key}`);
        if (btn) {
          btn.addEventListener("click", function () {
            try {
              if (window.loadChannelHeadlines) {
                const ch = window.CHANNELS[key] || {};
                window.loadChannelHeadlines(key, ch.label || key);
              }
            } catch (e) {
              console.error("channel headlines button hook error", e);
            }
          });
        }
      });

      const mobileSelect = document.getElementById("channel-select-mobile");
      if (mobileSelect) {
        mobileSelect.addEventListener("change", function (e) {
          const key = e.target.value;
          if (!key) return;
          try {
            if (window.loadChannelHeadlines) {
              const ch = window.CHANNELS[key] || {};
              window.loadChannelHeadlines(key, ch.label || key);
            }
          } catch (err) {
            console.error("channel headlines mobile hook error", err);
          }
        });
      }

      const firstKey = window.CHANNEL_ORDER[0];
      if (firstKey && window.loadChannelHeadlines) {
        const ch = window.CHANNELS[firstKey] || {};
        window.loadChannelHeadlines(firstKey, ch.label || firstKey);
      }
    } catch (e) {
      console.error("initNews error", e);
    }
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initNews);
  } else {
    initNews();
  }
})();
