<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="/favicon.png">
  <meta charset="UTF-8" />
  <title>Russell TV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      padding: 0;
      background: url("/background.png") no-repeat center center fixed;
      background-size: cover;
      background-color: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #fff;
    }

    header {
      background: rgba(0,0,0,0.8);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }

    .mode-toggle {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      border: 1px solid #ffffff44;
      background: rgba(0,0,0,0.7);
      color: #fff;
      font-size: 0.85rem;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn.active {
      background: #2e7dd7;
      border-color: #2e7dd7;
    }

    #single-view,
    #grid-view {
      padding: 0.75rem;
      box-sizing: border-box;
    }

    #single-player-hls,
    #single-player-yt {
      width: 100%;
      height: calc(100vh - 140px);
      display: none;
      border-radius: 12px;
      background: #000;
      border: none;
      max-height: calc(100vh - 160px);
    }

    #grid-view {
      display: none;
    }

    .grid-wrapper {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-auto-rows: minmax(0, 1fr);
      gap: 0.75rem;
    }

    .grid-cell {
      position: relative;
      background: rgba(0,0,0,0.5);
      border-radius: 12px;
      padding: 0.5rem;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      gap: 0.35rem;
    }

    .grid-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      z-index: 2;
    }

    .grid-label {
      padding: 3px 6px;
      background: rgba(0,0,0,0.8);
      font-size: 0.75rem;
      border-radius: 4px;
    }

    .grid-select {
      font-size: 0.75rem;
      background: rgba(0,0,0,0.8);
      color: #fff;
      border-radius: 4px;
      border: 1px solid #ffffff44;
      padding: 2px 4px;
      cursor: pointer;
    }

    .grid-cell video,
    .grid-cell iframe {
      width: 100%;
      height: 100%;
      border-radius: 10px;
      background: #000;
      border: none;
      flex: 1;
    }

    .grid-cell .yt-container {
      width: 100%;
      height: 100%;
      border-radius: 10px;
      background: #000;
      border: none;
      flex: 1;
    }
  </style>
</head>

<body>
  <header>
    <h1>Russell TV</h1>
    <div id="dynamic-buttons" class="mode-toggle"></div>
    <div class="mode-toggle">
      <button id="btn-single" class="btn active">Single</button>
      <button id="btn-grid" class="btn">Grid (4)</button>
    </div>
  </header>

  <main>
    <!-- SINGLE VIEW -->
    <section id="single-view">
      <video id="single-player-hls" controls autoplay muted></video>
      <div
        id="single-player-yt"
        style="display:none;"></div>
    </section>

    <!-- GRID VIEW -->
    <section id="grid-view">
      <div class="grid-wrapper">
        <!-- CELLS GENERATED DYNAMICALLY -->
      </div>
    </section>
  </main>

  <!-- LOAD CONFIG FIRST -->
  <script src="/config/channels.js"></script>

  <!-- HLS.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <!-- YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    // Single view DOM
    const singleView = document.getElementById("single-view");
    const gridView = document.getElementById("grid-view");
    const singleHLS = document.getElementById("single-player-hls");
    const singleYTContainer = document.getElementById("single-player-yt");

    const btnSingle = document.getElementById("btn-single");
    const btnGrid = document.getElementById("btn-grid");

    let hlsSingle = null;
    const hlsGrid = {};
    const YT_PLAYERS = {};

    function onYouTubeIframeAPIReady() {
      // API is ready; players are created lazily when needed.
    }

    function getYouTubeVideoId(url) {
      if (!url) return null;
      const idx = url.indexOf("/embed/");
      if (idx === -1) return null;
      let idPart = url.substring(idx + 7);
      const qIdx = idPart.indexOf("?");
      if (qIdx !== -1) idPart = idPart.substring(0, qIdx);
      return idPart;
    }

    function destroyYTPlayer(playerKey) {
      if (YT_PLAYERS[playerKey]) {
        try {
          YT_PLAYERS[playerKey].destroy();
        } catch (e) {
          console.warn("Error destroying YT player", playerKey, e);
        }
        delete YT_PLAYERS[playerKey];
      }
    }

    function createOrReplaceYTPlayer(container, playerKey, videoUrl) {
      const videoId = getYouTubeVideoId(videoUrl);
      if (!videoId) {
        console.warn("Could not parse YouTube video ID from URL:", videoUrl);
        return;
      }

      destroyYTPlayer(playerKey);

      container.innerHTML = "";
      const innerId = playerKey + "-inner";
      const inner = document.createElement("div");
      inner.id = innerId;
      inner.style.width = "100%";
      inner.style.height = "100%";
      container.appendChild(inner);

      function build() {
        if (window.YT && typeof YT.Player === "function") {
          const player = new YT.Player(innerId, {
            videoId: videoId,
            playerVars: {
              autoplay: 1,
              mute: 1,
              controls: 1,
              rel: 0,
              playsinline: 1
            },
            events: {
              onReady: (e) => {
                // Request at least 480p
                e.target.setPlaybackQuality("large");
              },
              onStateChange: (e) => {
                if (e.data === YT.PlayerState.PLAYING) {
                  e.target.setPlaybackQuality("large");
                }
              }
            }
          });
          YT_PLAYERS[playerKey] = player;
        } else {
          setTimeout(build, 100);
        }
      }

      build();
    }

    //------------------------------------------------------------------------
    // DYNAMIC BUTTONS (HEADER)
    //------------------------------------------------------------------------
    const headerBtnContainer = document.getElementById("dynamic-buttons");

    CHANNEL_ORDER.forEach(key => {
      const btn = document.createElement("button");
      btn.id = `btn-${key}`;
      btn.className = "btn";
      btn.textContent = CHANNELS[key].label;

      btn.addEventListener("click", () => {
        enterSingleMode();
        setSingleChannel(key);
      });

      headerBtnContainer.appendChild(btn);
    });

    function highlightHeaderButton(key) {
      const all = headerBtnContainer.querySelectorAll(".btn");
      all.forEach(b => b.classList.remove("active"));

      const active = document.getElementById(`btn-${key}`);
      if (active) active.classList.add("active");
    }

    //------------------------------------------------------------------------
    // SINGLE VIEW FUNCTIONS
    //------------------------------------------------------------------------
    function stopSingle() {
      if (hlsSingle) {
        hlsSingle.destroy();
        hlsSingle = null;
      }
      singleHLS.pause();
      singleHLS.removeAttribute("src");
      singleHLS.load();

      destroyYTPlayer("single");
      singleYTContainer.innerHTML = "";
      singleYTContainer.style.display = "none";
      singleHLS.style.display = "block";
    }

    function setSingleChannel(key) {
      const ch = CHANNELS[key];
      highlightHeaderButton(key);

      stopGrid();
      stopSingle();

      if (ch.type === "yt") {
        singleHLS.style.display = "none";
        singleYTContainer.style.display = "block";
        createOrReplaceYTPlayer(singleYTContainer, "single", ch.url);
      } else {
        singleYTContainer.style.display = "none";
        singleHLS.style.display = "block";

        if (Hls.isSupported()) {
          hlsSingle = new Hls({ lowLatencyMode: true });
          hlsSingle.loadSource(ch.url);
          hlsSingle.attachMedia(singleHLS);
        } else {
          singleHLS.src = ch.url;
        }
      }
    }

    function enterSingleMode() {
      btnSingle.classList.add("active");
      btnGrid.classList.remove("active");
      singleView.style.display = "block";
      gridView.style.display = "none";
      stopGrid();
    }

    //------------------------------------------------------------------------
    // GRID VIEW FUNCTIONS
    //------------------------------------------------------------------------)
    function buildGrid() {
      const wrapper = gridView.querySelector(".grid-wrapper");

      wrapper.innerHTML = ""; // clear any stale content

      for (let cell = 1; cell <= 4; cell++) {
        const div = document.createElement("div");
        div.className = "grid-cell";
        div.dataset.cell = cell;

        const header = document.createElement("div");
        header.className = "grid-header";

        const label = document.createElement("div");
        label.className = "grid-label";
        label.id = `label-cell-${cell}`;
        header.appendChild(label);

        const sel = document.createElement("select");
        sel.className = "grid-select";
        sel.dataset.cell = cell;

        Object.keys(CHANNELS).forEach(key => {
          const opt = document.createElement("option");
          opt.value = key;
          opt.textContent = CHANNELS[key].label;
          sel.appendChild(opt);
        });

        sel.addEventListener("change", (e) => {
          const c = parseInt(e.target.dataset.cell);
          playGridCell(c, e.target.value);
        });

        header.appendChild(sel);
        div.appendChild(header);

        const vid = document.createElement("video");
        vid.id = `grid-video-${cell}`;
        vid.autoplay = true;
        vid.muted = true;
        vid.controls = true;

        const ytDiv = document.createElement("div");
        ytDiv.id = `grid-yt-${cell}`;
        ytDiv.className = "yt-container";
        ytDiv.style.display = "none";

        div.appendChild(vid);
        div.appendChild(ytDiv);

        wrapper.appendChild(div);
      }
    }

    function stopGrid() {
      for (let k in hlsGrid) {
        if (hlsGrid[k]) {
          hlsGrid[k].destroy();
          hlsGrid[k] = null;
        }
      }

      // Destroy all grid YT players
      Object.keys(YT_PLAYERS).forEach((key) => {
        if (key.startsWith("grid-")) {
          destroyYTPlayer(key);
        }
      });

      for (let cell = 1; cell <= 4; cell++) {
        const v = document.getElementById(`grid-video-${cell}`);
        const y = document.getElementById(`grid-yt-${cell}`);
        if (v) {
          v.pause();
          v.removeAttribute("src");
          v.load();
        }
        if (y) {
          y.innerHTML = "";
          y.style.display = "none";
        }
      }
    }

    function playGridCell(cell, key) {
      const ch = CHANNELS[key];
      const label = document.getElementById(`label-cell-${cell}`);
      const video = document.getElementById(`grid-video-${cell}`);
      const ytDiv = document.getElementById(`grid-yt-${cell}`);

      label.textContent = ch.label;

      // Reset old
      if (hlsGrid[cell]) {
        hlsGrid[cell].destroy();
        hlsGrid[cell] = null;
      }
      video.pause();
      video.removeAttribute("src");
      video.load();

      destroyYTPlayer(`grid-${cell}`);
      ytDiv.innerHTML = "";

      if (ch.type === "yt") {
        video.style.display = "none";
        ytDiv.style.display = "block";
        createOrReplaceYTPlayer(ytDiv, `grid-${cell}`, ch.url);
      } else {
        ytDiv.style.display = "none";
        video.style.display = "block";

        if (Hls.isSupported()) {
          const h = new Hls({ lowLatencyMode: true });
          h.loadSource(ch.url);
          h.attachMedia(video);
          hlsGrid[cell] = h;
        } else {
          video.src = ch.url;
        }
      }
    }

    function enterGridMode() {
      btnGrid.classList.add("active");
      btnSingle.classList.remove("active");

      singleView.style.display = "none";
      gridView.style.display = "block";

      stopSingle();

      for (let cell = 1; cell <= 4; cell++) {
        const defaultKey = GRID_DEFAULTS[cell];
        const sel = gridView.querySelector(`select[data-cell="\${cell}"]`);
        const selector = gridView.querySelector('select[data-cell="' + cell + '"]');
        if (selector) {
          selector.value = defaultKey;
        }
        playGridCell(cell, defaultKey);
      }
    }

    //------------------------------------------------------------------------
    // MODE BUTTON EVENTS
    //------------------------------------------------------------------------
    btnSingle.addEventListener("click", enterSingleMode);
    btnGrid.addEventListener("click", enterGridMode);

    //------------------------------------------------------------------------
    // INITIALIZE
    //------------------------------------------------------------------------
    window.addEventListener("load", () => {
      buildGrid();
      setSingleChannel("cbs");
    });
  </script>
  <script src="/config/time-config.js"></script>
  <script src="/config/weather-config.js"></script>
  <script src="/config/info-bar.js"></script>
  <script src="/config/time-config.js"></script>
  <script src="/config/weather-config.js"></script>
  <script src="/config/info-bar.js"></script>
</body>
</html>
